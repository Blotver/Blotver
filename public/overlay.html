<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>Overlay</title>
    <script src="/socket.io/socket.io.js"></script>

    <style>
        body {
            margin: 0;
            background: transparent;
            overflow: hidden;
        }

        #clip {
            position: absolute;
            width: 600px;
            height: 340px;
            border-radius: 16px;
            overflow: hidden;
            display: none;
        }

        video {
            width: 100%;
            height: 100%;
            border-radius: 16px;
            object-fit: cover;
        }
    </style>
</head>

<body>

    <div id="clip">
        <iframe id="clipFrame" width="600" height="340" frameborder="0" allowfullscreen>
        </iframe>
    </div>

    <script>
        const projectId = window.location.pathname.split("/").pop();
        const socket = io();
        const clipDiv = document.getElementById("clip");
        const iframe = document.getElementById("clipFrame");

        let queue = [];
        let playing = false;

        socket.emit("joinProject", projectId);

        socket.on("newClip", (data) => {
            queue.push(data);
            playNext();
        });

        function playNext() {
            if (playing || queue.length === 0) return;

            playing = true;
            const data = queue.shift();

            console.log("VIDEO URL:", data.videoUrl);

            // Convertimos clip URL a embed
            const clipId = data.videoUrl.split("/clip/")[1];

            iframe.src = `https://clips.twitch.tv/embed?clip=${clipId}&parent=localhost&autoplay=true`;

            clipDiv.style.display = "block";

            setTimeout(resetPlayer, data.duration * 1000 || 15000);
        }

        function resetPlayer() {
            iframe.src = "";
            clipDiv.style.display = "none";
            playing = false;
            playNext();
        }
    </script>

</body>

</html>