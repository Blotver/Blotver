<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>Overlay</title>
    <script src="/socket.io/socket.io.js"></script>

    <style>
        body {
            margin: 0;
            background: transparent;
            overflow: hidden;
        }

        #clip {
            position: absolute;
            width: 600px;
            height: 340px;
            border-radius: 16px;
            overflow: hidden;
            display: none;
        }

        video {
            width: 100%;
            height: 100%;
            border-radius: 16px;
            object-fit: cover;
        }
    </style>
</head>

<body>
    <div id="clip">
        <video id="clipVideo" autoplay></video>
    </div>

    <script>
        const projectId = window.location.pathname.split("/").pop();
        const socket = io();
        const clipDiv = document.getElementById("clip");
        const video = document.getElementById("clipVideo");

        let queue = [];
        let playing = false;

        socket.emit("joinProject", projectId);

        socket.on("newClip", (data) => {
            queue.push(data);
            playNext();
        });

        function playNext() {
            if (playing || queue.length === 0) return;

            playing = true;
            const data = queue.shift();

            console.log("MP4 URL:", data.videoUrl);

            video.src = data.videoUrl;
            video.currentTime = 0;

            clipDiv.style.display = "block";

            video.play();

            video.onended = () => {
                resetPlayer();
            };

            // fallback por si no dispara onended
            setTimeout(resetPlayer, (data.duration * 1000) || 15000);
        }

        function resetPlayer() {
            video.pause();
            video.src = "";
            clipDiv.style.display = "none";
            playing = false;
            playNext();
        }
    </script>
</body>

</html>